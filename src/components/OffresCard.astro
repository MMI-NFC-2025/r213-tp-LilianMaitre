---
const { offre } = Astro.props;
import PbImage from "./PbImage.astro";

const images = Array.isArray(offre.maison_images)
	? offre.maison_images
	: offre.maison_images
		? [offre.maison_images]
		: [];
---

<article class="offre-card">
	<div class="offre-image" data-carousel>
		<div class="offre-carousel-track">
			{
				images.length > 0 ? (
					images.map((image, index) => (
						<div
							class:list={["offre-carousel-slide", { "is-active": index === 0 }]}
							data-carousel-slide
							aria-hidden={index === 0 ? "false" : "true"}
						>
							<PbImage record={offre} recordImage={image} />
						</div>
					))
				) : (
					<div class="offre-carousel-slide is-active" data-carousel-slide aria-hidden="false">
						<div class="offre-placeholder">Aucune image</div>
					</div>
				)
			}
		</div>
		<button class="offre-carousel-btn prev" type="button" data-carousel-prev aria-label="Image precedente">
			&lt;
		</button>
		<button class="offre-carousel-btn next" type="button" data-carousel-next aria-label="Image suivante">
			&gt;
		</button>
		{images.length > 1 && (
			<div class="offre-carousel-counter" data-carousel-counter>
				1 / {images.length}
			</div>
		)}
	</div>
	<div class="offre-body">
		<h2 class="offre-title">{offre.maison_name}</h2>
		<p class="offre-address">{offre.maison_adresse}</p>
		<div class="offre-meta">
			<span>{offre.maison_surface} m2</span>
			<span>{offre.chambres_nombre} ch</span>
			<span>{offre.nombre_SdB} sdb</span>
		</div>
		<div class="offre-footer">
			<span class="offre-price">${offre.maison_prix} / mois</span>
			<button
				class:list={["favori-toggle", { "is-fav": offre.favori }]}
				type="button"
				data-favori={offre.favori ? "true" : "false"}
				aria-pressed={offre.favori ? "true" : "false"}
			>
				{offre.favori ? "Favori" : "Ajouter"}
			</button>
		</div>
	</div>
</article>

<style>
	:global(.offres-grid) {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		align-items: stretch;
	}

	:global(.offre) {
		flex: 0 0 260px;
	}

	.offre-card {
		background: #ffffff;
		border: 1px solid #e9e5df;
		border-radius: 14px;
		overflow: hidden;
		display: flex;
		flex-direction: column;
		box-shadow: 0 8px 16px rgba(34, 34, 59, 0.08);
		height: 100%;
	}

	.offre-image {
		background: #e5e5ef;
		aspect-ratio: 4 / 2.9;
		position: relative;
		overflow: hidden;
	}

	.offre-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.offre-carousel-track {
		height: 100%;
	}

	.offre-carousel-slide {
		display: none;
		height: 100%;
	}

	.offre-carousel-slide.is-active {
		display: block;
	}

	.offre-placeholder {
		height: 100%;
		display: grid;
		place-items: center;
		color: #4a4e69;
		font-size: 0.9rem;
	}

	.offre-carousel-btn {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		border: none;
		background: rgba(44, 44, 81, 0.7);
		color: #ffffff;
		width: 2rem;
		height: 2rem;
		border-radius: 999px;
		cursor: pointer;
		display: grid;
		place-items: center;
		font-size: 1rem;
	}

	.offre-carousel-btn.prev {
		left: 0.5rem;
	}

	.offre-carousel-btn.next {
		right: 0.5rem;
	}

	.offre-image.is-single .offre-carousel-btn,
	.offre-image.is-single .offre-carousel-counter {
		display: none;
	}

	.offre-carousel-counter {
		position: absolute;
		right: 0.5rem;
		bottom: 0.5rem;
		background: rgba(34, 34, 59, 0.7);
		color: #ffffff;
		font-size: 0.75rem;
		padding: 0.2rem 0.45rem;
		border-radius: 999px;
	}

	.offre-body {
		padding: 0.95rem 1.1rem 1.1rem;
		display: flex;
		flex-direction: column;
		gap: 0.65rem;
	}

	.offre-title {
		margin: 0;
		font-size: 1.1rem;
	}

	.offre-address {
		margin: 0;
		color: #4a4e69;
		font-size: 0.9rem;
	}

	.offre-meta {
		display: flex;
		gap: 0.75rem;
		flex-wrap: wrap;
		font-size: 0.85rem;
		color: #5c5f73;
	}

	.offre-footer {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 0.75rem;
	}

	.offre-price {
		font-weight: 700;
		color: #22223b;
		font-size: 1rem;
	}

	.favori-toggle {
		border: 1px solid #d4cfc7;
		background: #ffffff;
		color: #4a4e69;
		font-size: 0.8rem;
		padding: 0.25rem 0.7rem;
		border-radius: 999px;
		cursor: pointer;
		transition:
			transform 0.15s ease,
			background 0.2s ease,
			color 0.2s ease,
			border-color 0.2s ease;
	}

	.favori-toggle:hover {
		transform: translateY(-1px);
		border-color: #9a8c98;
		color: #22223b;
	}

	.favori-toggle.is-fav {
		background: #9a8c98;
		border-color: #9a8c98;
		color: #ffffff;
	}
</style>

<script>
	const carousels = document.querySelectorAll("[data-carousel]");

	carousels.forEach((carousel) => {
		const slides = Array.from(carousel.querySelectorAll("[data-carousel-slide]"));
		const prev = carousel.querySelector("[data-carousel-prev]");
		const next = carousel.querySelector("[data-carousel-next]");
		const counter = carousel.querySelector("[data-carousel-counter]");

		if (slides.length <= 1) {
			carousel.classList.add("is-single");
			return;
		}

		let index = slides.findIndex((slide) => slide.classList.contains("is-active"));
		if (index < 0) index = 0;

		const update = (nextIndex) => {
			index = (nextIndex + slides.length) % slides.length;
			slides.forEach((slide, i) => {
				const isActive = i === index;
				slide.classList.toggle("is-active", isActive);
				slide.setAttribute("aria-hidden", isActive ? "false" : "true");
			});

			if (counter) {
				counter.textContent = `${index + 1} / ${slides.length}`;
			}
		};

		prev?.addEventListener("click", () => update(index - 1));
		next?.addEventListener("click", () => update(index + 1));

		update(index);
	});
</script>
