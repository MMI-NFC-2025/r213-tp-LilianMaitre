---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
import OffresCard from "../components/OffresCard.astro";
import { getOffres } from "../js/backend";

const offres = await getOffres();

---

<Layout titre="Offres">
    <button id="favori-button" class="bg-slate-600 rounded-lg text-white p-2">
        Afficher les favoris</button
    >
    <div class="offres-grid">
        {
            offres.map((offre) => (
                <div class="offre" data-favori={offre.favori.toString()}>
                    <OffresCard offre={offre} />
                </div>
            ))
        }
    </div>

</Layout>

<script>
    const button = document.getElementById("favori-button");
    const grid = document.querySelector(".offres-grid");
    let showOnlyFavorites = false;

    grid?.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const toggle = target.closest(".favori-toggle");
        if (!toggle) return;

        const isFavori = toggle.getAttribute("data-favori") === "true";
        const nextValue = !isFavori;

        toggle.setAttribute("data-favori", nextValue ? "true" : "false");
        toggle.setAttribute("aria-pressed", nextValue ? "true" : "false");
        toggle.classList.toggle("is-fav", nextValue);
        toggle.textContent = nextValue ? "Favori" : "Ajouter";

        const cardWrapper = toggle.closest(".offre");
        if (cardWrapper) {
            cardWrapper.dataset.favori = nextValue ? "true" : "false";
            if (showOnlyFavorites && !nextValue) {
                cardWrapper.style.display = "none";
            }
        }
    });

    button?.addEventListener("click", () => {
        showOnlyFavorites = !showOnlyFavorites;
        const offres = document.querySelectorAll(".offre");

        offres.forEach((offre) => {
            const isFavori = offre.dataset.favori === "true";

            if (showOnlyFavorites) {
                offre.style.display = isFavori ? "block" : "none";
                button.textContent = "Afficher tout";
            } else {
                offre.style.display = "block";
                button.textContent = "Afficher les favoris";
            }
        });
    });
</script>
