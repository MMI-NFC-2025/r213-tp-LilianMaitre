---
import "../../styles/global.css";
import Layout from "../../layouts/Layout.astro";
import OffresCard from "../../components/OffresCard.astro";
import { getOffres } from "../../../backend.mjs";


const toutesLesOffres = await getOffres();
let offres = toutesLesOffres;
let message = "";

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const minPrix = parseInt(data.get("minPrix"));
    const maxPrix = parseInt(data.get("maxPrix"));

    if (isNaN(minPrix) || isNaN(maxPrix)) {
        message = "Veuillez entrer des prix valides.";
    } else if (maxPrix <= minPrix) {
        message = "Le prix max doit être supérieur au prix min.";
    } else {
        offres = toutesLesOffres.filter((maison) => {
            return maison.prix >= minPrix && maison.prix <= maxPrix;
        });
        message = `Résultat : ${offres.length} offre(s) trouvée(s).`;
    }
}
---

<Layout titre="Offres">
    <div class="p-4">
        <a
            href="/offres/add"
            class="inline-block mb-6 p-2 bg-red-500 hover:bg-red-700 text-white rounded shadow font-bold"
        >
            Créer une nouvelle offre
        </a>

        <section
            class="mb-6 p-4 rounded-xl border border-slate-200 bg-white shadow-sm"
        >
            <h2 class="text-xl font-bold text-slate-700 mb-4">Filtres</h2>

            <form method="POST" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label
                        for="minPrix"
                        class="block text-sm font-medium text-slate-700"
                        >Prix minimum (€)</label
                    >
                    <input
                        type="number"
                        name="minPrix"
                        id="minPrix"
                        placeholder="Ex: 500"
                        min="0"
                        class="mt-1 border border-slate-300 p-2 rounded-lg text-sm"
                    />
                </div>
                <div>
                    <label
                        for="maxPrix"
                        class="block text-sm font-medium text-slate-700"
                        >Prix maximum (€)</label
                    >
                    <input
                        type="number"
                        name="maxPrix"
                        id="maxPrix"
                        placeholder="Ex: 2000"
                        min="0"
                        class="mt-1 border border-slate-300 p-2 rounded-lg text-sm"
                    />
                </div>
                <button
                    type="submit"
                    class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600 transition-colors"
                >
                    Filtrer par prix
                </button>
            </form>

            {message && <p class="mt-4 text-blue-600 font-medium">{message}</p>}
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {offres.map((offre) => <OffresCard offre={offre} />)}
        </div>
    </div>
</Layout>
